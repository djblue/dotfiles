#!/bin/bash

if ! [ -x "$(command -v nvim)" ]; then
  vim $@
  exit $?
fi

root="$HOME/repos/dotfiles"

parse-args() {
  local found=0
  for arg in $@; do
    local file="$root/src/$(echo $arg | sed -E 's/.*\.(.*)/\1/')"
    if [ -f $file ]; then
      found=1
      printf "$file "
    else
      printf "$arg "
    fi
  done
  return $found
}

args=$(parse-args $@)

if [ "$?" == "1" ]; then
  cd $root
  trap "exit" INT TERM
  trap "kill 0" EXIT
  clojure -Aserver > server.log 2>&1 &
  NVIM_LISTEN_ADDRESS=127.0.0.1:7777 nvim $args
else
  vim $@
fi

